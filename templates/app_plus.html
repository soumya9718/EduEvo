<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EduEvo — Your Smart Study Companion</title>
<style>
  :root{
    --page-bg:linear-gradient(180deg,#060913,#071226);
    --bg:#0b1220;
    --panel:#081226;
    --panel-bg:linear-gradient(180deg, rgba(8,12,18,0.65), rgba(6,8,12,0.6));
    --card-bg:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
    --card-border:rgba(255,255,255,0.02);
    --muted:#94a3b8;
    --text:#e6eef8;
    --brand:#22c55e;
    --brand2:#16a34a;
    --border:#1e293b;
    --input-bg:#071126;
    --bubble-ai:#0b2230;
    --header-bg:rgba(6,9,16,0.7);
  }
  :root[data-theme="light"]{
    --page-bg:linear-gradient(180deg,#eef2ff,#ffffff);
    --bg:#ffffff;
    --panel:#f6f8ff;
    --panel-bg:linear-gradient(180deg,#ffffff,#f2f6ff);
    --card-bg:#ffffff;
    --card-border:#e2e8f0;
    --muted:#4b5563;
    --text:#0f172a;
    --brand:#16a34a;
    --brand2:#22c55e;
    --border:#d0d7e2;
    --input-bg:#ffffff;
    --bubble-ai:#f1f5f9;
    --header-bg:rgba(255,255,255,0.85);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--page-bg);color:var(--text);font-family:Inter,system-ui,Roboto,Arial;transition:background 0.3s ease,color 0.3s ease}
  header{position:sticky;top:0;background:var(--header-bg);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:30;transition:background 0.3s ease,border-color 0.3s ease}
  .wrap{max-width:1100px;margin:0 auto;padding:14px;display:flex;gap:12px;align-items:center}
  .logo{font-weight:800;font-size:20px}
  .pill{border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:13px}
  .header-actions{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
  .auth-info{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px;flex-wrap:wrap;justify-content:flex-end}
  .btn.tiny{padding:6px 10px;font-size:12px}
  .plan-pill{padding:6px 12px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--text);background:rgba(255,255,255,0.04)}
  main{max-width:1100px;margin:18px auto;padding:12px}
  .panel{background:var(--panel-bg);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 12px 34px rgba(0,0,0,0.3);transition:background 0.3s ease,border 0.3s ease,color 0.3s ease}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:repeat(2,1fr)}
  @media(max-width:900px){.two{grid-template-columns:1fr}}
  h1{margin:0;font-size:28px}
  .lead{color:var(--muted);margin:6px 0 10px;font-size:16px;min-height:22px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--input-bg);color:var(--text);transition:background 0.3s ease,border-color 0.3s ease,color 0.3s ease}
  .btn{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#06240f;font-weight:700;cursor:pointer}
  .btn.secondary{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn.small{padding:7px 11px;font-size:12px;border-radius:999px}
  .row{display:flex;gap:10px;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab-btn{padding:8px 12px;border-radius:8px;background:transparent;border:1px solid transparent;color:var(--muted);cursor:pointer}
  .tab-btn.active{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#06240f;font-weight:700}
  .mode-toggle{display:inline-flex;align-items:center;gap:2px;border-radius:999px;padding:3px;border:1px solid var(--border);background:rgba(15,23,42,0.9)}
  .mode-btn{min-width:90px;padding:6px 12px;border-radius:999px;border:0;background:transparent;font-size:13px;color:var(--muted);cursor:pointer}
  .mode-btn.active{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#06240f;font-weight:600;box-shadow:0 0 0 1px rgba(34,197,94,0.4)}
  .nice-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .result-card{position:relative;padding:14px;border-radius:12px;background:var(--card-bg);border:1px solid var(--card-border);overflow:hidden;transition:background 0.3s ease,border-color 0.3s ease,transform 0.2s ease,box-shadow 0.2s ease}
  .result-card::before{content:"";position:absolute;inset:0;border-radius:inherit;background:radial-gradient(circle at top left,rgba(56,189,248,0.3),transparent 60%);opacity:0;pointer-events:none;transition:opacity 0.3s ease}
  .result-card:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(15,23,42,0.6);border-color:rgba(148,163,184,0.3)}
  .result-card:hover::before{opacity:1}
  .result-card.news-main{grid-column:span 2;display:flex;flex-direction:column;gap:10px;padding:18px}
  .result-card.news-card{display:flex;flex-direction:column;gap:6px}
  .news-meta{display:flex;justify-content:space-between;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
  .news-badge{padding:3px 9px;border-radius:999px;border:1px solid var(--border);font-size:11px;opacity:0.9}
  .news-title{margin:0;font-size:17px}
  .news-desc{margin:0;font-size:13px;color:var(--muted)}
  .auth-profile{position:relative;display:flex;align-items:center}
  .auth-chip{display:flex;align-items:center;gap:8px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(15,23,42,0.8);color:var(--muted);font-size:13px;cursor:pointer}
  .avatar-circle{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#06240f}
  .profile-popover{position:absolute;top:120%;right:0;min-width:220px;padding:12px 14px;border-radius:12px;background:var(--panel-bg);border:1px solid var(--border);box-shadow:0 18px 45px rgba(15,23,42,0.8);opacity:0;pointer-events:none;transform:translateY(-4px);transition:opacity .16s ease,transform .16s ease}
  .auth-profile:hover .profile-popover{opacity:1;pointer-events:auto;transform:translateY(0)}
  .profile-popover h4{margin:0 0 4px;font-size:14px}
  .profile-popover .profile-meta{font-size:12px;color:var(--muted);margin:0 0 8px}
  .profile-popover .profile-plan{font-size:12px;margin:0 0 10px}
  .chat-window{height:320px;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px}
  .bubble{max-width:80%;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02)}
  .bubble.user{align-self:flex-end;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#06240f}
  .bubble.ai{align-self:flex-start;background:var(--bubble-ai)}
  .theme-toggle{border:1px solid var(--border);background:transparent;border-radius:999px;padding:6px 12px;font-size:12px;color:var(--text);cursor:pointer;transition:background 0.2s ease,color 0.2s ease,border-color 0.2s ease}
  .theme-toggle:hover{background:rgba(255,255,255,0.08)}
  .typing-indicator{font-style:italic;color:var(--muted);font-size:13px}
  /* Typewriter animation */
  .typewriter { display:inline-block; vertical-align:middle; }
  .typewriter .text { border-right:2px solid var(--brand); white-space:nowrap; overflow:hidden; display:inline-block; }
  /* Fade swap for loading messages */
  .fade-swap { opacity:0; transition:opacity .5s ease; min-height:80px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; }
  .fade-swap.show { opacity:1; }
  .loader-ring{position:relative;width:56px;height:56px;display:inline-block}
  .loader-ring span{position:absolute;box-sizing:border-box;width:100%;height:100%;border-radius:50%;border:3px solid transparent;border-top-color:var(--brand);animation:spin 1.2s linear infinite}
  .loader-ring span:nth-child(2){border-top-color:var(--brand2);animation-duration:1.6s;opacity:.8}
  .loader-ring span:nth-child(3){border-top-color:#38bdf8;animation-duration:2s;opacity:.5}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  .loader-caption{font-size:13px;color:var(--muted);text-align:center;max-width:260px}
  .hidden{display:none}
	#ad{
		text-align: center;
	}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="logo">EduEvo</div>
    <div class="pill">Smart Study Companion</div>
    <div class="header-actions">
      <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()">Light mode</button>
      <button id="backToSiteBtn" class="btn secondary tiny" onclick="goToWebsite()">Back to Website</button>
      <div class="auth-info">
        <div id="authProfile" class="auth-profile hidden">
          <div class="auth-chip">
            <div id="authAvatar" class="avatar-circle">U</div>
            <span id="authChipLabel">Signed in</span>
          </div>
          <div class="profile-popover">
            <h4 id="profileName">User</h4>
            <p id="profileEmail" class="profile-meta"></p>
            <p id="profilePlan" class="profile-plan"></p>
            <button id="profileUpgradeBtn" class="btn small" type="button" onclick="openUpgradePage()">Upgrade</button>
          </div>
        </div>
        <span id="planBadge" class="plan-pill hidden"></span>
        <button id="logoutBtn" class="btn secondary tiny hidden" onclick="logoutUser()">Logout</button>
      </div>
    </div>
  </div>
</header>

<main>
  <!-- Main app -->
  <section id="appMain">
    <div class="panel">
      <h1 id="greeting">EduEvo</h1>
      <!-- Typewriter rotating lines -->
      <p class="lead" id="typewriterArea">
        <span class="typewriter"><span id="typewriterText" class="text"></span></span>
      </p>

      <div class="grid two">
        <div class="card">
          <label>Search topic</label>
          <input id="topicInput" placeholder="Type topic e.g., Photosynthesis">
          <div class="row" style="margin-top:10px;justify-content:space-between">
            <div class="row">
              <button class="btn" onclick="startSearch()">Search</button>
              <button class="btn secondary" onclick="openChatTab()">Open Chat</button>
            </div>
            <div class="small muted">History: <span id="histCount">0</span></div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px">Controls</h3>
          <label>Preferred subject</label>
          <select id="prefSubject">
            <option>All</option>
            <option>Mathematics</option>
            <option>Physics</option>
            <option>Chemistry</option>
            <option>Biology</option>
            <option>English</option>
            <option>History</option>
            <option>Geography</option>
            <option>Economics</option>
            <option>Computer Science</option>
            <option>Programming</option>
            <option>Art</option>
            <option>Music</option>
            <option>Physical Education</option>
            <option>Psychology</option>
            <option>Sociology</option>
            <option>Political Science</option>
            <option>Business Studies</option>
            <option>Accounting</option>
            <option>Environmental Science</option>
            <option>Engineering</option>
            <option>Medicine</option>
            <option>Law</option>
            <option>Philosophy</option>
          </select>
          <div style="margin-top:10px" class="small muted">Notes: set word limit in Chat tab when generating AI notes.</div>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;align-items:center;gap:16px;width:100%">
          <div class="mode-toggle" aria-label="Mode tabs">
            <button class="mode-btn active" data-mode="learn" onclick="switchMode(event)">Learn</button>
            <button class="mode-btn" id="sideNewsBtn" data-mode="news" onclick="switchMode(event)">News</button>
          </div>
          <div id="learnControls" style="flex:1;display:flex;justify-content:space-between;align-items:center">
            <div class="tabs" role="tablist">
              <button class="tab-btn active" data-tab="videos" onclick="switchTab(event)">Videos</button>
              <button class="tab-btn" data-tab="articles" onclick="switchTab(event)">Articles</button>
              <button class="tab-btn" data-tab="pdfs" onclick="switchTab(event)">PDFs</button>
              <button class="tab-btn" data-tab="chat" onclick="switchTab(event)">Chat</button>
              <button class="tab-btn" data-tab="quiz" onclick="switchTab(event)">Quizzes</button>
            </div>
            <div class="row">
              <button class="btn secondary" onclick="clearHistory()">Clear History</button>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div id="tab_videos">
          <!-- Loading message area (fade swap) -->
          <div id="videosLoading" class="small muted fade-swap"></div>
          <div id="videosGrid" class="nice-grid"></div>
          <div id="videosLoadMore" class="load-more hidden">
            <button class="btn secondary" onclick="loadMore('videos')">Load More Videos</button>
          </div>
        </div>
        <div id="tab_news" class="hidden">
          <div id="newsLoading" class="small muted fade-swap"></div>
          <div id="newsGrid" class="nice-grid"></div>
        </div>
        <div id="tab_articles" class="hidden">
          <div id="articlesLoading" class="small muted fade-swap"></div>
          <div id="articlesGrid" class="nice-grid"></div>
          <div id="articlesLoadMore" class="load-more hidden">
            <button class="btn secondary" onclick="loadMore('articles')">Load More Articles</button>
          </div>
        </div>
        <div id="tab_pdfs" class="hidden">
          <div id="pdfsLoading" class="small muted fade-swap"></div>
          <div id="pdfsGrid" class="nice-grid"></div>
          <div id="pdfsLoadMore" class="load-more hidden">
            <button class="btn secondary" onclick="loadMore('pdfs')">Load More PDFs</button>
          </div>
          <div style="margin-top:8px" class="small muted">If no PDFs appear, try broader queries or click the web PDF search link.</div>
          <div style="margin-top:8px"><a id="pdfSearchLink" class="small muted" href="#" target="_blank">Search PDFs on web</a></div>
        </div>
        <div id="tab_chat" class="hidden">
          <div style="display:flex;gap:12px">
            <div style="flex:1" class="card">
              <div id="chatWindow" class="chat-window"></div>
              <div class="row" style="margin-top:8px">
                <input id="chatInput" placeholder="Ask EduEvo about the topic..." onkeydown="if(event.key==='Enter') sendChat()" />
                <button class="btn" onclick="sendChat()">Send</button>
              </div>
            </div>
            <div style="width:320px" class="card">
              <h3 style="margin-top:0">AI Tools</h3>
              <div class="small muted">Generate concise notes (choose word count) or ask conceptual questions.</div>
              <div style="margin-top:10px">
                <label>Notes word limit</label>
                <input id="aiWords" type="number" placeholder="80" />
                <div style="margin-top:8px" class="row">
                  <button class="btn" onclick="generateNotes()">Generate Notes</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="tab_quiz" class="hidden">
          <div id="quizContainer" class="card">
            <div id="quizLoading" class="small muted fade-swap"></div>
            <div id="quizContent"></div>
          </div>
        </div>

      </div>
    </div>

    <div style="height:12px"></div>

    <div class="panel card">
      <h3 style="margin:0 0 8px">Recent Searches & Progress</h3>
      <div id="progressArea" class="nice-grid"></div>
    </div>
    
  </section>
</main>

<!-- Modal container (PDF preview / notes) -->
<div id="modalContainer"></div>

<script>
/* --------- Frontend logic --------- */

/* Server-provided user (Jinja injection fallback) */
const serverUser = (function(){ try{ return JSON.parse('{{ user|tojson | safe }}' || 'null'); }catch(e){return null;} })();
const authUser = (function(){ try{ return JSON.parse('{{ auth_user|tojson | safe }}' || 'null'); }catch(e){return null;} })();
const THEME_STORAGE_KEY = 'eduevo_theme';
const BASIC_PLAN = 'basic';
const BASIC_QUIZ_LIMIT = 2;
const BASIC_QUIZ_STORAGE_KEY = 'basic_quiz_uses';
const PREMIUM_PLANS = ['basic','plus','max'];

/* UI elements */
const appMain = document.getElementById('appMain');
const logoutBtn = document.getElementById('logoutBtn');
const authStatus = document.getElementById('authStatus');
const themeToggleBtn = document.getElementById('themeToggle');
const planBadge = document.getElementById('planBadge');
let currentProfile = serverUser || null;

/* Typing rotation data (typewriter-style) */
const rotatingLines = [
  "Generates perfect notes",
  "Finds the best lectures",
  "Helps you study smarter",
  "Understands your class level",
  "Creates summaries instantly",
  "Picks top PDFs for you",
  "Organizes study plans",
  "Prepares quick revision"
];
let rIdx = 0;
let typingTimer = null;

/* Loading messages (fade swap) */
const loadingLines = [
  "Organizing smart notes for you…",
  "Scanning YouTube for top results…",
  "Checking class-specific explanations…",
  "Fetching verified PDFs and articles…",
  "Preparing subject-wise summaries…",
  "Optimizing resources for your level…"
];
let loadIdx = 0;
let loadSwapInterval = null;

/* Search result storage for load-more */
let currentSearchResults = { videos: [], articles: [], pdfs: [], displayedCount: { videos:0, articles:0, pdfs:0 } };

function initTheme(){
  const stored = localStorage.getItem(THEME_STORAGE_KEY);
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const initial = stored || (prefersDark ? 'dark' : 'light');
  applyTheme(initial);
}

function toggleTheme(){
  const current = document.documentElement.getAttribute('data-theme') || 'dark';
  const next = current === 'dark' ? 'light' : 'dark';
  applyTheme(next);
}

function applyTheme(theme){
  const normalized = theme === 'light' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', normalized);
  localStorage.setItem(THEME_STORAGE_KEY, normalized);
  if(themeToggleBtn){
    themeToggleBtn.textContent = normalized === 'dark' ? 'Light mode' : 'Dark mode';
  }
}

// -------- News for Plus/Max users --------
let newsLoaded = false;

async function ensureNewsLoaded(){
  if(newsLoaded) return;
  newsLoaded = true;
  const userPlan = getCurrentPlan();
  if(userPlan !== 'plus' && userPlan !== 'max'){
    const grid = document.getElementById('newsGrid');
    if(grid) grid.innerHTML = '<div class="card small muted">News is available only for Plus and Max plans.</div>';
    return;
  }
  startLoadingSwap('newsLoading');
  try{
    const res = await fetch('/api/news');
    stopLoadingSwap('newsLoading');
    if(!res.ok){
      const grid = document.getElementById('newsGrid');
      if(grid) grid.innerHTML = '<div class="card small muted">Failed to load news.</div>';
      return;
    }
    const data = await res.json();
    renderNews(data.items || []);
  }catch(e){
    stopLoadingSwap('newsLoading');
    const grid = document.getElementById('newsGrid');
    if(grid) grid.innerHTML = '<div class="card small muted">Failed to load news.</div>';
    console.error('news error', e);
  }
}

function renderNews(items){
  const grid = document.getElementById('newsGrid');
  if(!grid) return;
  grid.innerHTML = '';
  if(!items.length){
    grid.innerHTML = '<div class="card small muted">No recent news found right now.</div>';
    return;
  }

  // First item as main story
  const [first, ...rest] = items;
  const main = document.createElement('div');
  main.className = 'result-card news-main';
  main.innerHTML = `
    <div class="news-meta">
      <span class="news-badge">${escapeHtml(first.source || 'News')}</span>
      <span>${escapeHtml(first.time || '')}</span>
    </div>
    <h3 class="news-title">${escapeHtml(first.title || 'News')}</h3>
    <p class="news-desc">${escapeHtml(first.summary || '')}</p>
    <div class="row" style="margin-top:10px">
      ${first.link ? `<a class="btn small" href="${first.link}" target="_blank" rel="noopener">Read full story</a>` : ''}
    </div>
  `;
  grid.appendChild(main);

  rest.forEach(item => {
    const card = document.createElement('div');
    card.className = 'result-card news-card';
    card.innerHTML = `
      <div class="news-meta">
        <span>${escapeHtml(item.source || '')}</span>
        <span>${escapeHtml(item.time || '')}</span>
      </div>
      <h3 class="news-title" style="font-size:15px">${escapeHtml(item.title || 'News')}</h3>
      <p class="news-desc">${escapeHtml(item.summary || '')}</p>
      ${item.link ? `<div class="row" style="margin-top:6px"><a class="btn secondary small" href="${item.link}" target="_blank" rel="noopener">Open article</a></div>` : ''}
    `;
    grid.appendChild(card);
  });
}

function goToWebsite(){
  window.location.href = '/';
}

function formatPlanLabel(planValue){
  const normalized = (planValue || 'free').toString().trim().toLowerCase();
  if(!normalized) return 'Free';
  return normalized.charAt(0).toUpperCase() + normalized.slice(1);
}

function getCurrentPlan(){
  return ((currentProfile && currentProfile.plan) || 'free').toLowerCase();
}

function getBasicQuizUsage(){
  return Number(localStorage.getItem(BASIC_QUIZ_STORAGE_KEY) || '0');
}

function incrementBasicQuizUsage(){
  const updated = getBasicQuizUsage() + 1;
  localStorage.setItem(BASIC_QUIZ_STORAGE_KEY, updated);
}

function showBasicUpgradePrompt(customMessage){
  const quizContent = document.getElementById('quizContent');
  if(!quizContent) return;
  const remaining = Math.max(BASIC_QUIZ_LIMIT - getBasicQuizUsage(), 0);
  const message = customMessage || `Basic plan includes ${BASIC_QUIZ_LIMIT} quiz searches. Upgrade to Pro or Max for unlimited quizzes.`;
  quizContent.innerHTML = `<div class="card" style="padding:24px;text-align:center">
    <h3 style="margin:0 0 8px">Upgrade to unlock quizzes</h3>
    <p class="small" style="margin:0 0 16px">${message}${remaining > 0 ? ` (${remaining} search${remaining===1?'':'es'} remaining today)` : ''}</p>
    <button class="btn" onclick="openUpgradePage()">Upgrade to Pro / Max</button>
  </div>`;
}

function openUpgradePage(){
  window.location.href = '/pricing';
}

/* Prefill UI from server */
(function initApp(){
  initTheme();
  updateAuthHeader();
  loadProfileUI();
  hideAdsForPremium();
})();

function hideAdsForPremium() {
  // Always hide ads for Plus/Max users
  const adDiv = document.getElementById('ad');
  if (adDiv) {
    adDiv.style.display = 'none';
    // Also remove any ad scripts
    const adScripts = document.querySelectorAll('script[src*="highperformanceformat"], script[src*="ad"]');
    adScripts.forEach(script => script.remove());
  }
}

function updateAuthHeader(){
  if(authUser){
    if(authStatus) authStatus.textContent = `Signed in as ${authUser.name}`;
    if(logoutBtn) logoutBtn.classList.remove('hidden');
    if(planBadge){
      planBadge.textContent = `Plan: ${formatPlanLabel(getCurrentPlan())}`;
      planBadge.classList.remove('hidden');
    }

    // Update hover profile chip
    try{
      const profileDiv = document.getElementById('authProfile');
      const avatarEl = document.getElementById('authAvatar');
      const chipLabel = document.getElementById('authChipLabel');
      const nameEl = document.getElementById('profileName');
      const emailEl = document.getElementById('profileEmail');
      const planEl = document.getElementById('profilePlan');
      const upgradeBtn = document.getElementById('profileUpgradeBtn');

      if(profileDiv){
        const name = authUser.name || '';
        const email = authUser.email || '';
        const plan = (getCurrentPlan() || 'free').toLowerCase();

        // initials for avatar
        const initials = name
          .split(' ')
          .filter(Boolean)
          .slice(0, 2)
          .map(part => part.charAt(0).toUpperCase())
          .join('') || 'U';

        if(avatarEl) avatarEl.textContent = initials;
        if(chipLabel) chipLabel.textContent = `Signed in as ${name || 'User'}`;
        if(nameEl) nameEl.textContent = name || 'User';
        if(emailEl) emailEl.textContent = email;
        if(planEl) planEl.textContent = `Current plan: ${formatPlanLabel(plan)}`;

        if(upgradeBtn){
          if(plan === 'free'){
            upgradeBtn.textContent = 'Upgrade to Plus';
            upgradeBtn.classList.remove('hidden');
          }else if(plan === 'basic' || plan === 'plus'){
            upgradeBtn.textContent = 'Upgrade to Max';
            upgradeBtn.classList.remove('hidden');
          }else{
            // Max or other top tier
            upgradeBtn.classList.add('hidden');
          }
        }

        profileDiv.classList.remove('hidden');
      }
    }catch(e){ console.warn('profile chip update failed', e); }
  } else {
    if(authStatus) authStatus.textContent = '';
    if(logoutBtn) logoutBtn.classList.add('hidden');
    if(planBadge) planBadge.classList.add('hidden');
    const profileDiv = document.getElementById('authProfile');
    if(profileDiv) profileDiv.classList.add('hidden');
  }
}

/* Load profile into UI */
function loadProfileUI(){
  const fallback = authUser ? {name: authUser.name, class:'', interests:'', plan:'free'} : null;
  const p = serverUser || fallback;
  currentProfile = p;
  if(p){
    document.getElementById('greeting').textContent = `Hi ${p.name} — EduEvo`;
    document.getElementById('typewriterText').textContent = rotatingLines[0];
    document.getElementById('topicInput').placeholder = `${p.name}, what would you like to study today?`;
    const first = (p.interests || '').split(',')[0]?.trim();
    if(first){
      const sel = document.getElementById('prefSubject');
      for(let i=0;i<sel.options.length;i++){ if(sel.options[i].text.toLowerCase().includes(first.toLowerCase())){ sel.selectedIndex=i; break; } }
    }
  } else {
    document.getElementById('greeting').textContent = 'EduEvo';
    document.getElementById('typewriterText').textContent = rotatingLines[0];
    document.getElementById('topicInput').placeholder = 'What would you like to study today?';
  }
  updateAuthHeader();
  renderHistory();
  startTypewriterRotation();
  // Hide News tab for non-Plus/Max users
  try{
    const plan = getCurrentPlan();
    const sideNews = document.getElementById('sideNewsBtn');
    if(sideNews && (plan !== 'plus' && plan !== 'max')){
      sideNews.style.display = 'none';
    }
  }catch(e){ console.warn('plan/news init failed', e); }
}

/* Typewriter rotation implementation (type -> pause -> delete -> next) */
function startTypewriterRotation(){
  const el = document.getElementById('typewriterText');
  if(!el) return;
  stopTypewriterRotation();
  rIdx = 0;
  (function cycle(){
    const txt = rotatingLines[rIdx];
    typeString(el, txt, 40, function(){
      setTimeout(function(){
        deleteString(el, 30, function(){
          rIdx = (rIdx+1) % rotatingLines.length;
          cycle();
        });
      }, 900);
    });
  })();
}
function stopTypewriterRotation(){ if(typingTimer) { clearTimeout(typingTimer); typingTimer = null; } }
function typeString(el, text, speed, cb){
  el.style.width = 'auto';
  el.textContent = '';
  let i=0;
  function step(){
    if(i<=text.length){ el.textContent = text.slice(0,i); i++; typingTimer=setTimeout(step,speed); }
    else { typingTimer = setTimeout(cb,0); }
  }
  step();
}
function deleteString(el, speed, cb){
  let text = el.textContent || '';
  let i = text.length;
  function step(){
    if(i>=0){ el.textContent = text.slice(0,i); i--; typingTimer=setTimeout(step,speed); }
    else { typingTimer = setTimeout(cb,0); }
  }
  step();
}

/* Fade-swap loading messages rotate while searching */
function startLoadingSwap(containerId){
  stopLoadingSwap(containerId);
  const el = document.getElementById(containerId);
  if(!el) return;
  loadIdx = 0;
  const captionId = containerId + '_caption';
  el.innerHTML = '<div class="loader-ring"><span></span><span></span><span></span></div>' +
                 '<div id="' + captionId + '" class="loader-caption"></div>';
  const captionEl = document.getElementById(captionId);
  if(captionEl) captionEl.textContent = loadingLines[loadIdx];
  el.classList.add('show');
  loadSwapInterval = setInterval(function(){
    const cap = document.getElementById(captionId);
    if(!cap) return;
    el.classList.remove('show');
    setTimeout(function(){
      loadIdx = (loadIdx+1) % loadingLines.length;
      cap.textContent = loadingLines[loadIdx];
      el.classList.add('show');
    }, 500);
  }, 1800);
}
function stopLoadingSwap(containerId){
  const el = document.getElementById(containerId);
  if(el){ el.classList.remove('show'); el.innerHTML = ''; }
  if(loadSwapInterval){ clearInterval(loadSwapInterval); loadSwapInterval = null; }
}

/* Tabs */
let currentMode = 'learn'; // 'learn' or 'news'

function switchMode(ev){
  const mode = ev.currentTarget.dataset.mode || 'learn';
  if(mode === currentMode) return;
  currentMode = mode;
  document.querySelectorAll('.mode-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.mode === mode);
  });

  if(mode === 'news'){
    // News-only view: hide learn controls and show just the news grid
    const lc = document.getElementById('learnControls');
    if(lc) lc.style.display = 'none';
    document.getElementById('tab_news').classList.remove('hidden');
    document.getElementById('tab_videos').classList.add('hidden');
    document.getElementById('tab_articles').classList.add('hidden');
    document.getElementById('tab_pdfs').classList.add('hidden');
    document.getElementById('tab_chat').classList.add('hidden');
    document.getElementById('tab_quiz').classList.add('hidden');
    ensureNewsLoaded();
  } else {
    // Back to learn mode: restore learn controls and active tab (default to videos)
    const lc = document.getElementById('learnControls');
    if(lc) lc.style.display = 'flex';
    const activeTab = document.querySelector('.tab-btn.active') || document.querySelector('.tab-btn[data-tab="videos"]');
    if(activeTab){
      switchTab({currentTarget: activeTab});
    }
  }
}

function switchTab(ev){
  const tab = ev.currentTarget.dataset.tab;
  // If user clicks a learn tab while in news mode, switch back to learn
  if(currentMode === 'news'){
    currentMode = 'learn';
    document.querySelectorAll('.mode-btn').forEach(b=>{
      b.classList.toggle('active', b.dataset.mode === 'learn');
    });
    const lc = document.getElementById('learnControls');
    if(lc) lc.style.display = 'flex';
  }
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
  document.getElementById('tab_videos').classList.toggle('hidden', tab!=='videos');
  // News visibility is controlled by side mode; keep it hidden in learn mode
  if(currentMode === 'news'){
    document.getElementById('tab_news').classList.remove('hidden');
  } else {
    document.getElementById('tab_news').classList.add('hidden');
  }
  document.getElementById('tab_articles').classList.toggle('hidden', tab!=='articles');
  document.getElementById('tab_pdfs').classList.toggle('hidden', tab!=='pdfs');
  document.getElementById('tab_chat').classList.toggle('hidden', tab!=='chat');
  document.getElementById('tab_quiz').classList.toggle('hidden', tab!=='quiz');
}
function openChatTab(){
  document.querySelectorAll('.tab-btn').forEach(b=>{ if(b.dataset.tab==='chat') b.classList.add('active'); else b.classList.remove('active'); });
  document.getElementById('tab_videos').classList.add('hidden');
  document.getElementById('tab_articles').classList.add('hidden');
  document.getElementById('tab_pdfs').classList.add('hidden');
  document.getElementById('tab_chat').classList.remove('hidden');
}

/* Search flow */
async function startSearch(){
  const topic = document.getElementById('topicInput').value.trim();
  if(!topic) return alert('Enter a topic');
  // save history locally
  let hist = JSON.parse(localStorage.getItem('eduevo_history') || '[]');
  hist.push({topic, when: new Date().toISOString()});
  localStorage.setItem('eduevo_history', JSON.stringify(hist));
  renderHistory();

  // show loading placeholders (rotating)
  startLoadingSwap('videosLoading');
  startLoadingSwap('articlesLoading');
  startLoadingSwap('pdfsLoading');

  document.getElementById('videosGrid').innerHTML = '';
  document.getElementById('articlesGrid').innerHTML = '';
  document.getElementById('pdfsGrid').innerHTML = '';

  try{
    const classPref = (currentProfile && currentProfile.class) || '';
    const subject = document.getElementById('prefSubject').value || 'All';
    const searchTopic = classPref ? `${topic} class ${classPref} ${subject}` : `${topic} ${subject}`;

    const res = await fetch('/api/search', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({topic: searchTopic})
    });
    const j = await res.json();

    stopLoadingSwap('videosLoading');
    stopLoadingSwap('articlesLoading');
    stopLoadingSwap('pdfsLoading');

    // store results
    currentSearchResults.videos = j.videos || [];
    currentSearchResults.articles = j.articles || [];
    const resolvedPdfs = (Array.isArray(j.pdfs) && j.pdfs.length) ? j.pdfs : (j.articles || []).filter(a=>a.pdf);
    currentSearchResults.pdfs = resolvedPdfs || [];
    currentSearchResults.displayedCount = { videos:0, articles:0, pdfs:0 };

    // render first batch
    renderVideos(currentSearchResults.videos.slice(0,12));
    currentSearchResults.displayedCount.videos = Math.min(12, currentSearchResults.videos.length);

    renderArticles(currentSearchResults.articles.slice(0,12));
    currentSearchResults.displayedCount.articles = Math.min(12, currentSearchResults.articles.length);

    const pdfLink = j.pdf_search_link || j.web_search_link || '#';
    renderPDFs(currentSearchResults.pdfs.slice(0,12), pdfLink);
    currentSearchResults.displayedCount.pdfs = Math.min(12, currentSearchResults.pdfs.length);

    // toggle load more visibility
    document.getElementById('videosLoadMore').classList.toggle('hidden', currentSearchResults.displayedCount.videos >= currentSearchResults.videos.length);
    document.getElementById('articlesLoadMore').classList.toggle('hidden', currentSearchResults.displayedCount.articles >= currentSearchResults.articles.length);
    document.getElementById('pdfsLoadMore').classList.toggle('hidden', currentSearchResults.displayedCount.pdfs >= currentSearchResults.pdfs.length);

    // Always generate quizzes for Plus/Max users
    const userPlan = getCurrentPlan();
    currentTopic = topic;
    await handleQuizAccess(userPlan, topic);

    // default to videos tab
    document.querySelector('.tab-btn[data-tab="videos"]').click();
  }catch(e){
    stopLoadingSwap('videosLoading');
    stopLoadingSwap('articlesLoading');
    stopLoadingSwap('pdfsLoading');
    console.error(e); alert('Search failed');
  }
}

async function handleQuizAccess(plan, topic){
  const normalizedPlan = (plan || '').toLowerCase();
  if(normalizedPlan === BASIC_PLAN){
    const used = getBasicQuizUsage();
    if(used >= BASIC_QUIZ_LIMIT){
      showBasicUpgradePrompt();
      return;
    }
    const generated = await generateQuizzes(topic, normalizedPlan);
    if(generated){
      incrementBasicQuizUsage();
    }
    return;
  }
  await generateQuizzes(topic, normalizedPlan);
}

/* Load more */
function loadMore(type){
  const increment = 8;
  const start = currentSearchResults.displayedCount[type];
  const end = start + increment;

  if(type==='videos'){
    renderVideos(currentSearchResults.videos.slice(0,end), true);
    currentSearchResults.displayedCount.videos = Math.min(end, currentSearchResults.videos.length);
    document.getElementById('videosLoadMore').classList.toggle('hidden', currentSearchResults.displayedCount.videos >= currentSearchResults.videos.length);
  } else if(type==='articles'){
    renderArticles(currentSearchResults.articles.slice(0,end), true);
    currentSearchResults.displayedCount.articles = Math.min(end, currentSearchResults.articles.length);
    document.getElementById('articlesLoadMore').classList.toggle('hidden', currentSearchResults.displayedCount.articles >= currentSearchResults.articles.length);
  } else if(type==='pdfs'){
    renderPDFs(currentSearchResults.pdfs.slice(0,end), '', true);
    currentSearchResults.displayedCount.pdfs = Math.min(end, currentSearchResults.pdfs.length);
    document.getElementById('pdfsLoadMore').classList.toggle('hidden', currentSearchResults.displayedCount.pdfs >= currentSearchResults.pdfs.length);
  }
}

/* Renderers */
function renderVideos(videos, append=false){
  const grid = document.getElementById('videosGrid');
  if(!append) grid.innerHTML='';
  if(!videos || videos.length===0){
    if(!append) grid.innerHTML = '<div class="card small muted">No videos found.</div>';
    return;
  }
  videos.forEach(v=>{
    const div = document.createElement('div'); div.className='result-card';
    div.innerHTML = `<h3 style="margin:0">${escapeHtml(v.title||'Video')}</h3>
      <div class="small muted">Channel: ${escapeHtml(v.channel || 'Unknown')}</div>
      <div style="margin-top:8px" class="row">
        <a class="btn" href="${v.url}" target="_blank" rel="noopener">Watch Video</a>
      </div>`;
    grid.appendChild(div);
  });
}

function renderArticles(articles, append=false){
  const grid = document.getElementById('articlesGrid');
  if(!append) grid.innerHTML='';
  if(!articles || articles.length===0){
    if(!append) grid.innerHTML = '<div class="card small muted">No articles found.</div>';
    return;
  }
  articles.forEach(a=>{
    const div = document.createElement('div'); div.className='result-card';
    const auths = (a.authors||[]).slice(0,3).join(', ');
    div.innerHTML = `<h3 style="margin:0">${escapeHtml(a.title||'Article')}</h3>
      <div class="small muted">${escapeHtml(auths)} • ${a.journal||''} • ${a.year||''}</div>
      <div style="margin-top:8px" class="row">
        ${a.pdf ? `<button class="btn" onclick="previewPDF('${encodeURIComponent(a.pdf)}')">Preview PDF</button>` : ''}
        ${a.pdf ? `<button class="btn secondary" onclick="downloadPDF('${encodeURIComponent(a.pdf)}')">Download</button>` : ''}
        ${a.url ? `<a class="btn secondary" href="${a.url}" target="_blank">View Article</a>` : ''}
      </div>`;
    grid.appendChild(div);
  });
}

function renderPDFs(pdfs, pdfSearchLink, append=false){
  const grid = document.getElementById('pdfsGrid');
  if(!append) grid.innerHTML='';
  const linkSource = pdfSearchLink || document.getElementById('pdfSearchLink')?.href || '#';
  if(!append && linkSource){
    const linkEl = document.getElementById('pdfSearchLink');
    if(linkEl) linkEl.href = linkSource;
  }
  if(!pdfs || pdfs.length===0){
    if(!append){
      const safeLink = linkSource || '#';
      grid.innerHTML = `<div class="card small muted">No direct PDFs found. <a href="${safeLink}" target="_blank" class="small muted">Search PDFs on web</a></div>`;
    }
    return;
  }
  pdfs.forEach(p=>{
    const div=document.createElement('div'); div.className='result-card';
    div.innerHTML = `<h3 style="margin:0">${escapeHtml(p.title||'PDF')}</h3>
      <div class="small muted">${(p.authors||[]).slice(0,3).join(', ')} • ${p.year||''}</div>
      <div style="margin-top:8px" class="row">
        <button class="btn" onclick="previewPDF('${encodeURIComponent(p.pdf)}')">Preview</button>
        <button class="btn secondary" onclick="downloadPDF('${encodeURIComponent(p.pdf)}')">Download</button>
      </div>`;
    grid.appendChild(div);
  });
}

/* PDF preview/download */
function previewPDF(encUrl){
  const url = decodeURIComponent(encUrl);
  const modal = document.createElement('div');
  modal.innerHTML = `<div style="position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,0.7);z-index:120">
    <div style="width:92%;height:86%;background:var(--panel);border-radius:10px;padding:12px;display:flex;flex-direction:column">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small muted">PDF Preview</div>
        <div>
          <button class="btn secondary" onclick="this.closest('div[role=dialog]').parentElement.remove()">Close</button>
        </div>
      </div>
      <div style="flex:1;margin-top:8px;border-radius:8px;overflow:hidden;display:grid;place-items:center">
        <div class="small muted">Loading PDF preview...</div>
      </div>
    </div></div>`;
  modal.setAttribute('role','dialog');
  document.getElementById('modalContainer').appendChild(modal);
  // load iframe after short delay
  setTimeout(()=>{
    const iframe = document.createElement('iframe');
    iframe.src = url;
    iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.border='0';
    modal.querySelector('div > div:last-child').innerHTML = '';
    modal.querySelector('div > div:last-child').appendChild(iframe);
  },100);
}

function downloadPDF(encUrl){
  const url = decodeURIComponent(encUrl);
  const dl = '/download?url=' + encodeURIComponent(url);
  const a = document.createElement('a'); a.href = dl; a.download=''; document.body.appendChild(a); a.click(); a.remove();
}

/* Chat & AI */
async function sendChat(){
  const msg = document.getElementById('chatInput').value.trim();
  if(!msg) return;
  pushBubble(msg,'user'); document.getElementById('chatInput').value='';

  const typingId = showTypingIndicator();
  try{
    const res = await fetch('/api/chat', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message: msg})
    });
    hideTypingIndicator(typingId);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const j = await res.json();
    if(j.error) pushBubble(`Error: ${j.error}`, 'ai');
    else if(j.reply){
      if(j.reply_html) pushBubble(j.reply_html, 'ai', true);
      else pushBubble(j.reply, 'ai');
    } else pushBubble('No response from AI', 'ai');
  }catch(e){
    hideTypingIndicator(typingId); console.error(e); pushBubble('Error connecting to AI service', 'ai');
  }
}

function showTypingIndicator(){
  const win = document.getElementById('chatWindow');
  const b = document.createElement('div');
  const id = 'typing-' + Date.now();
  b.id = id; b.className = 'bubble ai';
  const span = document.createElement('span'); span.className='typing-indicator'; span.textContent='EduEvo is typing';
  b.appendChild(span); win.appendChild(b); win.scrollTop = win.scrollHeight;
  // animate dots
  let dots = 0;
  const iv = setInterval(()=>{ dots = (dots+1)%4; span.textContent = 'EduEvo is typing' + '.'.repeat(dots); win.scrollTop = win.scrollHeight; }, 500);
  b._iv = iv;
  return id;
}
function hideTypingIndicator(id){
  const el = document.getElementById(id);
  if(el){
    clearInterval(el._iv);
    if(el.parentElement) el.parentElement.removeChild(el);
  }
}

function pushBubble(text, who, rawHtml=false){
  const win = document.getElementById('chatWindow');
  const b = document.createElement('div'); b.className = 'bubble ' + (who==='user'?'user':'ai');
  if(rawHtml){
    const div = document.createElement('div'); div.style.whiteSpace='pre-wrap'; div.style.fontFamily='inherit'; div.innerHTML = text; b.appendChild(div);
  } else {
    const pre = document.createElement('pre'); pre.style.whiteSpace='pre-wrap'; pre.style.margin='0'; pre.style.fontFamily='inherit'; pre.textContent = text; b.appendChild(pre);
  }
  win.appendChild(b); win.scrollTop = win.scrollHeight;
}

/* Generate concise notes */
async function generateNotes(){
  const topic = document.getElementById('topicInput').value.trim();
  if(!topic) return alert('Search a topic first');
  const words = Number(document.getElementById('aiWords').value) || 80;
  const prompt = `Write a concise study-note on "${topic}" in about ${words} words. Include definition, one key idea/formula, and a short example.`;
  pushBubble(prompt,'user');
  const typingId = showTypingIndicator();
  try{
    const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message: prompt}) });
    hideTypingIndicator(typingId);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const j = await res.json();
    if(j.error) pushBubble(`Error: ${j.error}`, 'ai');
    else if(j.reply){
      if(j.reply_html) pushBubble(j.reply_html,'ai', true); else pushBubble(j.reply,'ai');
      const notes_html = j.reply_html ? j.reply_html : `<pre style="white-space:pre-wrap;margin-top:10px">${escapeHtml(j.reply||'')}</pre>`;
      const notes_plain = j.reply || '';
      const modal = document.createElement('div');
      modal.innerHTML = `<div style="position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,0.7);z-index:130">
        <div style="width:90%;max-width:800px;background:var(--panel);padding:12px;border-radius:10px">
          <div style="display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">AI Notes</h3><div><button class="btn secondary" onclick="this.closest('div[role=dialog]').parentElement.remove()">Close</button></div></div>
          <div style="margin-top:10px;white-space:pre-wrap">${notes_html}</div>
          <div style="margin-top:8px" class="row"><button class="btn" onclick="downloadText('notes_${topic.replace(/\\s+/g,'_')}.txt', \`${escapeBackticks(notes_plain)}\`)">Download Notes</button></div>
        </div></div>`;
      modal.setAttribute('role','dialog'); document.getElementById('modalContainer').appendChild(modal);
    } else pushBubble('No response from AI','ai');
  }catch(e){ hideTypingIndicator(typingId); console.error('Generate notes error:', e); alert('Failed to generate notes'); }
}

/* History & progress */
function renderHistory(){
  const area = document.getElementById('progressArea'); area.innerHTML='';
  const hist = JSON.parse(localStorage.getItem('eduevo_history') || '[]').slice().reverse().slice(0,8);
  document.getElementById('histCount').textContent = hist.length;
  hist.forEach(h=>{
    const div = document.createElement('div'); div.className='result-card';
    div.innerHTML = `<h3 style="margin:0">${escapeHtml(h.topic)}</h3><div class="small muted">${new Date(h.when).toLocaleString()}</div><div style="margin-top:8px" class="row"><button class="btn secondary" onclick="setTopic('${escapeAttr(h.topic)}')">Open</button></div>`;
    area.appendChild(div);
  });
}
function setTopic(t){ document.getElementById('topicInput').value = t; startSearch(); }
function clearHistory(){ localStorage.removeItem('eduevo_history'); renderHistory(); alert('History cleared'); }

/* Quiz functionality */
let currentQuizzes = [];
let currentQuizIndex = 0;
let currentQuestionIndex = 0;
let quizAnswers = [];
let quizStartTime = null;
let completedQuizzes = {}; // Track completed quizzes with scores {quizNumber: {score, time, completed}}
let currentTopic = '';
let quizMode = false; // false = list view, true = quiz mode
let currentQuizStartTime = null;
let questionStartTime = null; // Track time for each question

async function generateQuizzes(topic, plan) {
  const quizContainer = document.getElementById('quizContainer');
  const quizContent = document.getElementById('quizContent');
  const quizLoading = document.getElementById('quizLoading');
  const quizPlan = (plan || 'free').toLowerCase();
  
  currentTopic = topic;
  quizContent.innerHTML = '';
  startLoadingSwap('quizLoading');
  
  try {
    const numQuizzes = quizPlan === 'max' ? 999 : quizPlan === BASIC_PLAN ? 1 : 10;
    const quizzes = [];
    
    // Generate first quiz
    const res = await fetch('/api/generate-quiz', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({topic: topic, quiz_number: 1, num_questions: 10, difficulty: 'easy'})
    });
    
    if (!res.ok) {
      const error = await res.json();
      if(res.status === 403 && quizPlan === BASIC_PLAN){
        showBasicUpgradePrompt(error.error);
      } else {
        quizContent.innerHTML = `<div class="small muted">${error.error || 'Failed to generate quizzes'}</div>`;
      }
      return false;
    }
    
    const quizData = await res.json();
    quizzes.push(quizData);
    
    // For Plus plan, generate 2 more quizzes (total 3)
    if (quizPlan === 'plus') {
      for (let i = 2; i <= 3; i++) {
        const res2 = await fetch('/api/generate-quiz', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({topic: topic, quiz_number: i, num_questions: 10, difficulty: i === 2 ? 'medium' : 'hard'})
        });
        if (res2.ok) {
          const quizData2 = await res2.json();
          quizzes.push(quizData2);
        }
      }
    }
    
    // For Max plan, initially generate 3 quizzes, user can generate more
    if (quizPlan === 'max') {
      for (let i = 2; i <= 3; i++) {
        const res2 = await fetch('/api/generate-quiz', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({topic: topic, quiz_number: i, num_questions: 10, difficulty: i === 2 ? 'medium' : 'hard'})
        });
        if (res2.ok) {
          const quizData2 = await res2.json();
          quizzes.push(quizData2);
        }
      }
    }
    
    // All quiz fetches finished successfully; stop loading and render
    stopLoadingSwap('quizLoading');
    
    currentQuizzes = quizzes;
    currentQuizIndex = 0;
    currentQuestionIndex = 0;
    quizAnswers = [];
    quizMode = false;
    completedQuizzes = {};
    
    renderQuizList();
    return true;
  } catch (e) {
    stopLoadingSwap('quizLoading');
    console.error('Quiz generation error', e);
    quizContent.innerHTML = `<div class="small muted">Failed to generate quizzes: ${e.message}</div>`;
    return false;
  }
}

function renderQuizList() {
  const quizContent = document.getElementById('quizContent');
  quizMode = false;
  
  const userPlan = getCurrentPlan();
  const remainingBasicQuota = userPlan === BASIC_PLAN ? Math.max(BASIC_QUIZ_LIMIT - getBasicQuizUsage(), 0) : null;
  
  let quizListHTML = '<div style="max-height:500px;overflow-y:auto;padding-right:8px">';
  
  // Show all available quizzes
  for (let i = 0; i < currentQuizzes.length; i++) {
    const quizNum = i + 1;
    const isCompleted = completedQuizzes[quizNum];
    const statusColor = isCompleted ? 'var(--brand)' : 'var(--muted)';
    const statusText = isCompleted ? `✓ Completed (${isCompleted.score}%)` : 'Not Started';
    let difficultyLabel = '';
    let difficultyColor = '';
    if (quizNum === 1) { difficultyLabel = 'Easy'; difficultyColor = '#22c55e'; }
    else if (quizNum === 2) { difficultyLabel = 'Medium'; difficultyColor = '#eab308'; }
    else { difficultyLabel = 'Hard'; difficultyColor = '#ef4444'; }
    const isMaxPlan = userPlan === 'max';
    
    quizListHTML += `
      <div class="card" style="padding:16px;margin-bottom:12px;border-left:4px solid ${statusColor};cursor:pointer;transition:all 0.2s" 
           onclick="startQuiz(${i})" 
           onmouseover="this.style.background='rgba(255,255,255,0.05)'" 
           onmouseout="this.style.background='rgba(255,255,255,0.02)'">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <h3 style="margin:0;color:${statusColor}">Quiz ${quizNum}</h3>
            <span class="small" style="padding:2px 8px;border-radius:999px;background:${difficultyColor}1a;color:${difficultyColor};border:1px solid ${difficultyColor}66">${difficultyLabel}</span>
            ${isMaxPlan ? '<span class="small" style="padding:2px 8px;border-radius:999px;background:rgba(56,189,248,0.1);color:#38bdf8;border:1px solid rgba(56,189,248,0.6)">Max</span>' : ''}
          </div>
          <span class="small" style="color:${statusColor}">${statusText}</span>
        </div>
        ${isCompleted ? `<div class="small muted" style="margin-top:8px">Time: ${formatTime(isCompleted.time)}</div>` : ''}
      </div>
    `;
  }
  
  // Add "Generate New Set" button for Max users
  if (userPlan === 'max') {
    quizListHTML += `
      <div style="margin-top:20px;text-align:center">
        <button class="btn" onclick="generateMoreQuizzes()">Generate New Set of Quiz</button>
      </div>
    `;
  }
  
  if (userPlan === BASIC_PLAN) {
    quizListHTML += `
      <div class="card" style="padding:16px;margin-top:12px;text-align:center">
        <div class="small muted">Basic plan limit: ${BASIC_QUIZ_LIMIT} quiz search${BASIC_QUIZ_LIMIT===1?'':'es'} per day. ${remainingBasicQuota > 0 ? `${remainingBasicQuota} left.` : 'Limit reached.'}</div>
        <div style="margin-top:10px"><button class="btn" onclick="openUpgradePage()">Upgrade to Pro / Max</button></div>
      </div>
    `;
  }
  
  quizListHTML += '</div>';
  quizContent.innerHTML = quizListHTML;
}

async function generateMoreQuizzes() {
  const userPlan = (currentProfile && currentProfile.plan) || 'max';
  if (userPlan !== 'max') return;
  
  const nextQuizNumber = currentQuizzes.length + 1;
  const quizContent = document.getElementById('quizContent');
  
  // Show loading
  quizContent.innerHTML = '<div class="small muted" style="text-align:center;padding:20px">Generating new quiz set...</div>';
  
  try {
    const res = await fetch('/api/generate-quiz', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({topic: currentTopic, quiz_number: nextQuizNumber, num_questions: 10, difficulty: 'hard'})
    });
    
    if (res.ok) {
      const quizData = await res.json();
      currentQuizzes.push(quizData);
      renderQuizList();
    } else {
      const error = await res.json();
      quizContent.innerHTML = `<div class="small muted" style="text-align:center;padding:20px">${error.error || 'Failed to generate quiz'}</div>`;
      setTimeout(() => renderQuizList(), 2000);
    }
  } catch (e) {
    console.error('Generate more quizzes error', e);
    quizContent.innerHTML = `<div class="small muted" style="text-align:center;padding:20px">Error: ${e.message}</div>`;
    setTimeout(() => renderQuizList(), 2000);
  }
}

function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}m ${secs}s`;
}

function startQuiz(quizIndex) {
  currentQuizIndex = quizIndex;
  currentQuestionIndex = 0;
  quizAnswers = [];
  quizMode = true;
  currentQuizStartTime = Date.now();
  questionStartTime = Date.now();
  renderQuiz();
}

function renderQuiz() {
  const quizContent = document.getElementById('quizContent');
  if (!quizMode) {
    renderQuizList();
    return;
  }
  
  if (currentQuizzes.length === 0) {
    quizContent.innerHTML = '<div class="small muted">No quizzes available</div>';
    return;
  }
  
  const quiz = currentQuizzes[currentQuizIndex];
  const question = quiz.questions[currentQuestionIndex];
  
  if (!question) {
    // Quiz complete, show results
    showQuizResults();
    return;
  }
  
  const progress = ((currentQuestionIndex + 1) / 10) * 100;
  const questionStartTime = Date.now();
  const questionElapsed = currentQuestionIndex > 0 ? Math.floor((questionStartTime - (currentQuizStartTime + (currentQuestionIndex * 5000))) / 1000) : 0;
  
  quizContent.innerHTML = `
    <div style="margin-bottom:20px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div class="small muted">Quiz ${currentQuizIndex + 1} • Question ${currentQuestionIndex + 1} of 10</div>
        <div style="display:flex;gap:12px;align-items:center">
          <span class="small muted">Time: <span id="questionTimer">0s</span></span>
          <button class="btn secondary" style="padding:6px 12px;font-size:12px" onclick="renderQuizList()">Back to List</button>
        </div>
      </div>
      <div style="width:100%;height:8px;background:rgba(255,255,255,0.1);border-radius:4px">
        <div style="width:${progress}%;height:100%;background:linear-gradient(135deg,var(--brand),var(--brand2));border-radius:4px;transition:width 0.3s"></div>
      </div>
    </div>
    <div class="card" style="padding:24px">
      <h3 style="margin:0 0 24px;font-size:20px">${escapeHtml(question.question)}</h3>
      <div style="display:flex;flex-direction:column;gap:12px">
        ${question.options.map((opt, idx) => `
          <button class="btn secondary" style="text-align:left;justify-content:flex-start;padding:14px;font-size:15px" onclick="selectAnswer('${String.fromCharCode(65 + idx)}')">
            ${String.fromCharCode(65 + idx)}. ${escapeHtml(opt)}
          </button>
        `).join('')}
      </div>
    </div>
  `;
  
  // Start timer for this question
  let questionTimer = 0;
  const timerInterval = setInterval(() => {
    questionTimer++;
    const timerEl = document.getElementById('questionTimer');
    if (timerEl) timerEl.textContent = `${questionTimer}s`;
  }, 1000);
  
  // Store timer interval to clear it later
  window.currentQuestionTimer = timerInterval;
}

function selectAnswer(answer) {
  // Clear question timer
  let questionTime = 0;
  if (window.currentQuestionTimer) {
    questionTime = parseInt(document.getElementById('questionTimer')?.textContent?.replace('s', '') || '0');
    clearInterval(window.currentQuestionTimer);
    window.currentQuestionTimer = null;
  }
  const quiz = currentQuizzes[currentQuizIndex];
  const question = quiz.questions[currentQuestionIndex];
  
  quizAnswers.push({
    question: question.question,
    options: question.options,
    user_answer: answer,
    correct_answer: question.correct_answer,
    time_taken: questionTime
  });
  
  currentQuestionIndex++;
  
  if (currentQuestionIndex >= quiz.questions.length) {
    // Quiz complete, show results
    showQuizResults();
  } else {
    renderQuiz();
  }
}

async function showQuizResults() {
  const quizContent = document.getElementById('quizContent');
  const quizNumber = currentQuizIndex + 1;
  const timeTaken = Math.floor((Date.now() - currentQuizStartTime) / 1000);
  
  // Show loading state for detailed analysis (especially when Max plan calls AI solutions)
  quizContent.innerHTML = `
    <div class="card" style="padding:24px;text-align:center">
      <h3 style="margin:0 0 12px">Generating detailed analysis…</h3>
      <div id="quizAnalysisLoading" class="fade-swap" style="margin-top:12px"></div>
    </div>
  `;
  startLoadingSwap('quizAnalysisLoading');

  // Submit answers to server
  try {
    const res = await fetch('/api/submit-quiz', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        topic: currentTopic,
        quiz_number: quizNumber,
        answers: quizAnswers
      })
    });
    
    const results = await res.json();
    const userPlan = getCurrentPlan();
    
    // Store completed quiz info
    completedQuizzes[quizNumber] = {
      score: results.score,
      time: timeTaken,
      completed: true
    };
    
    // Stop the temporary analysis loader now that we have results
    stopLoadingSwap('quizAnalysisLoading');

    if (userPlan === 'max') {
      const correctCount = results.correct;
      const totalCount = results.total;
      const incorrect = totalCount - correctCount;

      const wrongAnswers = results.answers.filter(a => a.user_answer !== a.correct_answer);
      let solutionsHTML = '';

      if (wrongAnswers.length > 0) {
        // Call backend to get AI explanations
        try {
          const solRes = await fetch('/api/quiz-solutions', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ topic: currentTopic, answers: wrongAnswers })
          });
          if (solRes.ok) {
            const solData = await solRes.json();
            const exps = Array.isArray(solData.explanations) ? solData.explanations : [];
            solutionsHTML = '<div style="margin-top:24px"><h4 style="margin:0 0 12px">AI Solutions for Incorrect Answers</h4>';
            wrongAnswers.forEach((ans, idx) => {
              const exp = exps[idx] || 'Explanation not available.';
              solutionsHTML += `
                <div style="padding:16px;margin-bottom:16px;background:rgba(255,255,255,0.03);border-radius:8px;border-left:4px solid #f87171">
                  <div style="font-weight:600;margin-bottom:8px;color:#f87171">Question: ${escapeHtml(ans.question)}</div>
                  <div class="small" style="margin-bottom:4px">Your answer: <strong>${ans.user_answer}</strong> ✗</div>
                  <div class="small" style="margin-bottom:4px">Correct answer: <strong>${ans.correct_answer}</strong> ✓</div>
                  <div class="small muted" style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1)">
                    <strong>AI Solution:</strong> ${exp.replace(/</g,'&lt;').replace(/>/g,'&gt;')}
                  </div>
                </div>
              `;
            });
            solutionsHTML += '</div>';
          }
        } catch (e) {
          console.error('quiz solutions error', e);
        }
      }
      
      quizContent.innerHTML = `
        <div style="margin-bottom:20px">
          <button class="btn secondary" style="padding:6px 12px;font-size:12px" onclick="renderQuizList()">← Back to Quiz List</button>
        </div>
        <div class="card" style="padding:24px;text-align:center;margin-bottom:20px">
          <h2 style="margin:0 0 16px">Quiz ${quizNumber} Complete!</h2>
          <div style="font-size:56px;font-weight:700;margin:20px 0;background:linear-gradient(135deg,var(--brand),var(--brand2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">
            ${results.score}%
          </div>
          <div class="small muted" style="margin-bottom:20px">
            You got ${results.correct} out of ${results.total} questions correct
          </div>
        </div>
        <div class="card" style="padding:20px;margin-bottom:20px">
          <h3 style="margin:0 0 16px">Detailed Analysis</h3>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">
            <div style="text-align:center;padding:16px;background:rgba(34,197,94,0.1);border-radius:10px;border:1px solid rgba(34,197,94,0.3)">
              <div style="font-size:28px;font-weight:700;color:var(--brand)">${correctCount}</div>
              <div class="small muted">Correct</div>
            </div>
            <div style="text-align:center;padding:16px;background:rgba(248,113,113,0.1);border-radius:10px;border:1px solid rgba(248,113,113,0.3)">
              <div style="font-size:28px;font-weight:700;color:#f87171">${incorrect}</div>
              <div class="small muted">Incorrect</div>
            </div>
            <div style="text-align:center;padding:16px;background:rgba(255,255,255,0.05);border-radius:10px;border:1px solid var(--border)">
              <div style="font-size:28px;font-weight:700">${totalCount}</div>
              <div class="small muted">Total</div>
            </div>
            <div style="text-align:center;padding:16px;background:rgba(59,130,246,0.1);border-radius:10px;border:1px solid rgba(59,130,246,0.3)">
              <div style="font-size:28px;font-weight:700;color:#3b82f6">${formatTime(timeTaken)}</div>
              <div class="small muted">Time Taken</div>
            </div>
          </div>
          <div style="margin-top:20px">
            <h4 style="margin:0 0 12px">Question Review</h4>
            ${results.answers.map((ans, idx) => {
              const isCorrect = ans.user_answer === ans.correct_answer;
              const timeTaken = ans.time_taken || 0;
              return `
                <div style="padding:12px;margin-bottom:12px;background:rgba(255,255,255,0.02);border-radius:8px;border-left:4px solid ${isCorrect ? 'var(--brand)' : '#f87171'}">
                  <div style="font-weight:600;margin-bottom:8px">Q${idx + 1}: ${escapeHtml(ans.question)}</div>
                  <div class="small" style="margin-bottom:4px">Your answer: <strong>${ans.user_answer}</strong> ${isCorrect ? '✓' : '✗'}</div>
                  <div class="small muted" style="margin-bottom:4px">Correct answer: <strong>${ans.correct_answer}</strong></div>
                  <div class="small muted" style="color:var(--muted)">Time taken: ${formatTime(timeTaken)}</div>
                </div>
              `;
            }).join('')}
          </div>
          ${solutionsHTML}
        </div>
        <div style="text-align:center">
          <button class="btn" onclick="renderQuizList()">Back to Quiz List</button>
        </div>
      `;
    } else {
      // Plus plan - simple results with Ok button
      quizContent.innerHTML = `
        <div style="margin-bottom:20px">
          <button class="btn secondary" style="padding:6px 12px;font-size:12px" onclick="renderQuizList()">← Back to Quiz List</button>
        </div>
        <div class="card" style="padding:32px;text-align:center">
          <h2 style="margin:0 0 20px">Quiz ${quizNumber} Complete!</h2>
          <div style="font-size:64px;font-weight:700;margin:24px 0;background:linear-gradient(135deg,var(--brand),var(--brand2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">
            ${results.score}%
          </div>
          <div class="small muted" style="margin-bottom:24px;font-size:16px">
            You got ${results.correct} out of ${results.total} questions correct
          </div>
          <button class="btn" style="padding:14px 32px;font-size:16px" onclick="renderQuizList()">Ok</button>
        </div>
      `;
    }
  } catch (e) {
    console.error('Submit quiz error', e);
    quizContent.innerHTML = `<div class="small muted">Error submitting quiz: ${e.message}</div>`;
  }
}

/* Utilities */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function escapeAttr(s){ return (s||'').replace(/'/g,"\\'").replace(/"/g,'\\"'); }
function escapeBackticks(s){ return (s||'').replace(/`/g,'\\`'); }
function downloadText(fn, txt){ const b=new Blob([txt],{type:'text/plain'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=fn; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u); }

async function logoutUser(){
  try{
    await fetch('/logout', {method:'POST'});
  }catch(e){
    console.error('Logout failed', e);
  }finally{
    window.location.href = '/auth';
  }
}
</script>
<!-- Ads removed for Plus/Max users -->
</body>
</html>

